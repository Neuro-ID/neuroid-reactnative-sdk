name: RN Smoke Tests

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

concurrency: 
  group: rn-smoke-tests-${{ github.ref }}
  cancel-in-progress: true

env:
  SDK_PATH: ${{ github.workspace }}
  APPS_PATH: ${{ github.workspace }}/.tmp

jobs:
  ios:
    name: iOS (RN ${{ matrix.RN_VERSION }})
    runs-on: macos-15-xlarge
    strategy:
      fail-fast: false
      matrix:
        RN_VERSION: ['0.73', '0.78', '0.83']
        # RN_VERSION: ['0.73', '0.74', '0.75', '0.76', '0.77', '0.78', '0.79', '0.80', '0.81', '0.82', '0.83']
        # RN_VERSION: ['0.73', '0.74', '0.75']
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24.x'
          registry-url: 'https://registry.npmjs.org'

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin

      - name: Define App Paths
        id: paths
        run: |
          RN_VERSION="${{ matrix.RN_VERSION }}"
          SAFE_MINOR="${RN_VERSION//./_}" # 0.80 -> 0_80
          APP_NAME="SmokeApp_$SAFE_MINOR"

          APP_DIR="${{ env.APPS_PATH }}/${APP_NAME}"

          echo "APP_NAME=$APP_NAME" >> $GITHUB_ENV
          echo "APP_DIR=$APP_DIR" >> $GITHUB_ENV

      - name: Create React Native App
        run: |
          mkdir -p "${{ env.APPS_PATH }}"
          rm -rf "${{ env.APP_DIR }}"
          cd "${{ env.APPS_PATH }}"

          npx @react-native-community/cli@latest init "${{ env.APP_NAME }}" \
          --version "${{ matrix.RN_VERSION }}" \
          --skip-install

      - name: Install JS Dependencies
        working-directory: ${{ env.APP_DIR }}
        run: yarn install

      - name: Install NeuroID SDK
        working-directory: ${{ env.APP_DIR }}
        run: yarn add "file:${{ env.SDK_PATH }}"

      - name: Install react-native-fs
        working-directory: ${{ env.APP_DIR }}
        run: yarn add react-native-fs

      - name: Install iOS Dependencies
        working-directory: ${{ env.APP_DIR }}/ios
        run: pod install --repo-update

      - name: Copy smoke templates into App
        run: |
          cp -R "${{ github.workspace }}/tests/SmokeRunner.ts" "${{ env.APP_DIR }}/SmokeRunner.ts"
          cp -R "${{ github.workspace }}/tests/App.tsx" "${{ env.APP_DIR }}/App.tsx"
          cp -R "${{ github.workspace }}/tests/consolePatch.ts" "${{ env.APP_DIR }}/consolePatch.ts"
          cp -R "${{ github.workspace }}/tests/fileLogger.ts" "${{ env.APP_DIR }}/fileLogger.ts"

      - name: Run Metro Server (in background)
        working-directory: ${{ env.APP_DIR }}
        run: | 
          nohup npx react-native start --port 8081 --no-interactive > metro.log 2>&1 &

          for i in {1..60}; do
            if curl -fsS "http://localhost:8081/status" | grep -q "packager-status:running"; then
              echo "Metro server is ready!"
              exit 0
            fi
            sleep 1
          done

          echo "Metro server failed to start within expected time."
          cat metro.log
          exit 1

      - name: Prepare Simulator
        run: |
          set -o pipefail
          xcrun simctl boot "iPhone 17 Pro" || true
          xcrun simctl list devices

      - name: Run iOS App (Simulator)
        working-directory: ${{ env.APP_DIR }}
        run: |
          set -o pipefail
          npx react-native run-ios --no-packager --port 8081 --simulator "iPhone 17 Pro"
          
          # Give the app time to install and launch
          echo "Waiting for app to install and launch..."
          sleep 10

      - name: Copy Logs from Device
        working-directory: ${{ env.APP_DIR }}/ios
        run: |
          DEVICE="iPhone 17 Pro"

          SCHEME=$(ls -d *.xcodeproj | sed 's/.xcodeproj//')
          echo "SCHEME: $SCHEME"
          
          BUNDLE_ID=$(xcodebuild -showBuildSettings -project ${SCHEME}.xcodeproj -scheme ${SCHEME} 2>/dev/null | grep "PRODUCT_BUNDLE_IDENTIFIER" | grep -v "DERIVE" | awk '{print $3}')
          echo "BUNDLE_ID: $BUNDLE_ID"
          
          if [ -z "$BUNDLE_ID" ]; then
            echo "Error: Could not determine BUNDLE_ID"
            exit 1
          fi

          APP_PATH="$(ls -td build/ios/Build/Products/*simulator/*.app | head -n 1)"
          echo "APP_PATH: $APP_PATH"

          # Make sure it's installed + launched
          xcrun simctl install "$DEVICE" "$APP_PATH" || true                            
          xcrun simctl launch "$DEVICE" "$BUNDLE_ID" || true
          
          CONTAINER="$(xcrun simctl get_app_container "$DEVICE" "$BUNDLE_ID" data 2>/dev/null || true)"
          echo "CONTAINER: $CONTAINER"

          # List all installed apps for debugging
          echo "=== Installed apps on simulator ==="
          xcrun simctl listapps "$DEVICE" | grep -E "(ApplicationType|CFBundleIdentifier|CFBundleName)"
          
          # Wait for app to be installed (up to 30 seconds)
          echo "Waiting for app to be installed..."
          for i in {1..30}; do
            if xcrun simctl listapps "$DEVICE" | grep -q "$BUNDLE_ID"; then
              echo "App is installed!"
              break
            fi
            echo "App not yet installed, waiting... ($i/30)"
            sleep 5
          done
          
          # Verify app is installed
          if ! xcrun simctl listapps "$DEVICE" | grep -q "$BUNDLE_ID"; then
            echo "Error: App with bundle ID $BUNDLE_ID is not installed on simulator after waiting"
            echo "=== Checking build logs ==="
            tail -50 ../ios-build.log || echo "No build log found"
            exit 1
          fi
          
          # Get container path
          CONTAINER_PATH=$(xcrun simctl get_app_container "$DEVICE" "$BUNDLE_ID" data 2>&1)
          if [ $? -ne 0 ]; then
            echo "Error getting container path: $CONTAINER_PATH"
            exit 1
          fi
          echo "CONTAINER_PATH: $CONTAINER_PATH"
          
          # Wait for log file to be created (up to 30 seconds)
          for i in {1..30}; do
            if [ -f "$CONTAINER_PATH/Documents/app.log" ]; then
              echo "Log file found!"
              cp "$CONTAINER_PATH/Documents/app.log" ../app.log
              exit 0
            fi
            echo "Waiting for log file... ($i/30)"
            sleep 1
          done
          
          echo "Error: Log file not found after 30 seconds"
          ls -la "$CONTAINER_PATH/Documents/" || echo "Documents directory does not exist"
          exit 1

      - name: Assert smoke PASS (from metro logs)
        working-directory: ${{ env.APP_DIR }}
        run: |          
          for i in {1..30}; do
            if grep -q "NID_RN_SDK_PASS" app.log; then
              echo "Smoke tests passed!"
              exit 0
            elif grep -q "NID_RN_SDK_FAIL" app.log; then
              echo "Smoke tests failed. Check logs for details."
              cat app.log
              exit 1
            fi
            sleep 2
          done

          echo "Smoke tests did not complete within expected time. Check metro logs for details."
          cat metro.log
          exit 1
