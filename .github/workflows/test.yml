name: NPM token test

on:
  pull_request:
    branches:
      - main

jobs:
  testing-npm-token:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
          fetch-tags: true

      - uses: actions/setup-node@v6
        with:
          node-version: '25.x'
          registry-url: 'https://registry.npmjs.org'
    
      - name: Show why npm thinks it has a token (redacted)
        run: |
          set -euo pipefail
          npm -v
          unset NODE_AUTH_TOKEN
          echo "== env presence =="
          for v in NODE_AUTH_TOKEN NPM_TOKEN npm_config__authToken npm_config__authtoken; do
          if [ -n "${!v-}" ]; then echo "$v=SET"; else echo "$v=NOT_SET"; fi
          done

          echo "== user npmrc existence =="
          if [ -f "$HOME/.npmrc" ]; then
          echo "~/.npmrc exists"
          sed -E 's/(_authToken=).+/\1REDACTED/g; s/(_auth=).+/\1REDACTED/g' "$HOME/.npmrc"
          else
          echo "~/.npmrc does not exist"
          fi

          echo "== npm config keys (redacted) =="
          npm config get //registry.npmjs.org/:_authToken | sed -E 's/.+/REDACTED_OR_EMPTY/'
